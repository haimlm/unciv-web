name: Web War Deep Nightly

on:
  schedule:
    - cron: '20 3 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  web-build:
    name: Build Web JS Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build web toolchain container
        run: docker build -f .devcontainer/Dockerfile -t unciv-web-builder .

      - name: Build JS bundle
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            unciv-web-builder \
            bash -lc "./gradlew --configuration-cache :web:webBuildJs"

      - name: Upload web dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: unciv-web-dist
          path: web/build/dist
          if-no-files-found: error

  web-ui-war-deep:
    name: Web UI War Deep (nightly)
    runs-on: ubuntu-latest
    needs: web-build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download web dist artifact
        uses: actions/download-artifact@v4
        with:
          name: unciv-web-dist
          path: web/build/dist

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright browser
        run: |
          npm config set fund false
          npm config set audit false
          npm install -D playwright ws
          npx playwright install --with-deps chromium

      - name: Start static server
        run: |
          python3 scripts/web/static-server.py --port 18080 --dir web/build/dist > /tmp/web-server.log 2>&1 &
          echo $! > /tmp/web-server.pid

      - name: Run UI war deep suite
        run: |
          xvfb-run -a env HEADLESS=false WEB_BASE_URL=http://127.0.0.1:18080 WEB_PROFILE=phase4-full WEB_UI_WAR_DEEP_TIMEOUT_MS=120000 \
          node scripts/web/run-web-ui-war-deep.js

      - name: Publish summary
        if: always()
        run: |
          node scripts/web/write-web-summary.js >> "$GITHUB_STEP_SUMMARY"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-ui-war-deep-nightly
          path: |
            /tmp/web-server.log
            tmp/web-ui-war-deep-result.json
            tmp/web-ui-war-deep-latest.png
